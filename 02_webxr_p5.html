<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR with Plane Detection and Water Effect</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
</head>
<body>
  <script>
    let video;
    let planeDetected = false;
    let waterEffectStarted = false;

    // Variables for water effect
    let cols, rows;
    let waveGrid = [];
    let resolution = 20;

    function setup() {
      createCanvas(windowWidth, windowHeight, WEBGL);

      // Access the camera
      video = createCapture(VIDEO);
      video.size(windowWidth, windowHeight);
      video.hide();

      // Initialize water effect grid
      cols = floor(width / resolution);
      rows = floor(height / resolution);
      for (let i = 0; i < cols; i++) {
        waveGrid[i] = [];
        for (let j = 0; j < rows; j++) {
          waveGrid[i][j] = 0; // Initialize height
        }
      }

      // Start WebXR session
      initWebXR();
    }

    function draw() {
      // Draw the camera feed
      push();
      translate(-width / 2, -height / 2, 0);
      image(video, 0, 0, width, height);
      pop();

      if (planeDetected && !waterEffectStarted) {
        startWaterEffect();
        waterEffectStarted = true;
      }

      // Draw water effect
      if (waterEffectStarted) {
        drawWaterEffect();
      }
    }

    function drawWaterEffect() {
      translate(-width / 2, -height / 2, 0);
      for (let i = 0; i < cols - 1; i++) {
        for (let j = 0; j < rows - 1; j++) {
          let x = i * resolution;
          let y = j * resolution;
          let nextX = (i + 1) * resolution;
          let nextY = (j + 1) * resolution;

          fill(0, 0, 255, 150);
          beginShape();
          vertex(x, y, waveGrid[i][j]);
          vertex(nextX, y, waveGrid[i + 1][j]);
          vertex(nextX, nextY, waveGrid[i + 1][j + 1]);
          vertex(x, nextY, waveGrid[i][j + 1]);
          endShape(CLOSE);

          // Update wave heights for animation
          waveGrid[i][j] = sin((frameCount + i * j) * 0.1) * 10;
        }
      }
    }

    async function initWebXR() {
      if (navigator.xr) {
        const session = await navigator.xr.requestSession("immersive-ar", {
          requiredFeatures: ["hit-test"]
        });

        session.addEventListener("select", () => {
          planeDetected = true;
        });

        session.addEventListener("end", () => {
          planeDetected = false;
          waterEffectStarted = false;
        });

        const referenceSpace = await session.requestReferenceSpace("local");
        const viewerSpace = await session.requestReferenceSpace("viewer");

        const hitTestSource = await session.requestHitTestSource({
          space: viewerSpace
        });

        session.requestAnimationFrame((time, frame) => {
          const hitTestResults = frame.getHitTestResults(hitTestSource);
          if (hitTestResults.length > 0) {
            planeDetected = true;
          }
        });
      } else {
        console.error("WebXR is not supported on this device.");
      }
    }

    function startWaterEffect() {
      console.log("Plane detected! Starting water effect...");
    }
  </script>
</body>
</html>
